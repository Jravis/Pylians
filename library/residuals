#!/usr/bin/env python

import numpy as np
import sys

if len(sys.argv)<3:
    print 'USAGE: residuals file1 file2 f_out'
    print 'The code will compute the ratio between the second'
    print 'column of file1 and the second column of file2'
    print 'if the first column is not the same the codes interpolates'
    print 'the interpolation by default is linear. If log-interpolation'
    print 'is wanted do: residuals file1 file2 f_out log'
    sys.exit()

#read the parameters
f1=sys.argv[1]; f2=sys.argv[2]; f_out=sys.argv[3]
if len(sys.argv)==4:
    method='linear'
elif (len(sys.argv)==5 and sys.argv[4]=='log'):
    method='log'
else:
    print 'Error: Type residuals for help'

#read the first file. If there is a third column it reads it.
f=open(f1,'r'); X1,Y1,dY1=[],[],[]
for line in f.readlines():
    a=line.split()
    X1.append(float(a[0])); Y1.append(float(a[1]))
    if len(a)>2:
        dY1.append(float(a[2]))
f.close(); X1=np.array(X1); Y1=np.array(Y1); dY1=np.array(dY1)

#read the second file. If there is a third column it reads it.
f=open(f2,'r'); X2,Y2,dY2=[],[],[]
for line in f.readlines():
    a=line.split()
    X2.append(float(a[0])); Y2.append(float(a[1]))
    if len(a)>2:
        dY2.append(float(a[2]))
f.close(); X2=np.array(X2); Y2=np.array(Y2); dY2=np.array(dY2)

#check if arrays are the same
if np.any(X1!=X2):
    print 'first columns are different.'
    if method=='linear':
        print 'Interpolating linearly...'
        print 'if log-log interpolation is desired use:'
        print 'python '+sys.argv[1]+' '+sys.argv[2]+' '+sys.argv[3]+' log'
        dumb=np.interp(X1,X2,Y2); Y2=dumb
    else:
        print 'Interpolating in log-log...'
        dumb=np.interp(np.log10(X1),np.log10(X2),np.log10(Y2))
        Y2=10**dumb
    
#compute the ratio
ratio=Y1/Y2

#if there are errors in the file1 compute the error on the ratio
flag=False
if len(dY1)==len(Y1):
    dratio=dY1/Y2
    flag=True

#write result to file
f=open(f_out,'w')
for i in range(len(X1)):
    if flag:
        f.write(str(X1[i])+' '+str(ratio[i])+' '+str(dratio[i])+'\n')
    else:
        f.write(str(X1[i])+' '+str(ratio[i])+'\n')
f.close()
